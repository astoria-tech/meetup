---
import {
  formatCompactDate,
  formatTime,
  getGoogleCalendarLink,
  renderMarkdown,
  getPreviewText,
  getEventColors,
} from "../utils/eventFormatting";
import { getEventTypeLabel } from "../utils/meetupApi";

interface Props {
  event: any;
  isPast?: boolean;
}

const { event, isPast = false } = Astro.props;
const colors = getEventColors(event.eventType);
---

<div
  class={`bg-slate-50 rounded-lg border ${colors.border} hover:shadow-lg hover:border-slate-400 transition-all duration-200 relative overflow-hidden ${isPast ? "opacity-75" : ""}`}
>
  {/* Date/Time Badge */}
  <div
    class={`absolute top-0 left-0 ${isPast ? "bg-gray-300 text-gray-700" : `${colors.badge} ${colors.badgeText}`} px-3 py-2 sm:px-4 sm:py-2.5 rounded-br-xl shadow-lg text-xs sm:text-sm z-10`}
  >
    <div class="font-bold leading-tight">
      {formatCompactDate(event.dateTime)}
    </div>
    <div class="font-semibold mt-0.5">
      {formatTime(event.dateTime)}
    </div>
  </div>

  {/* Event Type Badge */}
  <div class="absolute top-3 right-3 z-10">
    <span
      class={`inline-block ${colors.typeLabel} text-sm font-bold px-3 py-1.5 rounded-full whitespace-nowrap`}
    >
      {getEventTypeLabel(event.eventType)}
    </span>
  </div>

  <div class="pt-16 px-4 pb-4 sm:pl-36 sm:pr-4 sm:py-4">
    <header class="mb-3">
      <h3 class="text-lg font-semibold text-slate-900 mb-2">
        {event.title}
      </h3>
      <div class="flex flex-wrap gap-3 text-xs text-slate-600">
        <span>üìç {event.location.name}</span>
        {
          event.going > 0 && (
            <span>
              üë• {event.going} {isPast ? "attended" : "going"}
            </span>
          )
        }
      </div>
    </header>

    <main class="mb-3">
      <div
        class="description-container text-slate-700 text-sm"
        data-full-description={event.description}
      >
        <div class="description-preview line-clamp-2">
          <div set:html={getPreviewText(event.description)} />
        </div>
        <div class="description-full hidden">
          <div
            class="prose prose-slate prose-sm max-w-none [&>p]:my-3 [&>ul]:my-3 [&>ol]:my-3 [&>li]:my-1"
            set:html={renderMarkdown(event.description)}
          />
        </div>
        {
          event.description.length > 120 && (
            <button
              class="show-more-btn text-slate-600 hover:text-slate-900 text-xs font-medium mt-1 flex items-center gap-1"
              onclick="this.closest('.description-container').querySelector('.description-preview').classList.toggle('hidden'); this.closest('.description-container').querySelector('.description-full').classList.toggle('hidden'); this.querySelector('.caret').classList.toggle('rotate-180'); this.querySelector('.btn-text').textContent = this.querySelector('.btn-text').textContent === 'Show more' ? 'Show less' : 'Show more';"
            >
              <span class="btn-text">Show more</span>
              <svg
                class="caret w-3 h-3 transition-transform"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </button>
          )
        }
      </div>
    </main>

    <footer class="flex flex-wrap gap-2 items-center">
      {
        isPast ? (
          <a
            href={event.eventUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-2.5 px-4 rounded-lg text-sm transition-all duration-200 shadow-sm hover:shadow"
          >
            See event on Meetup
          </a>
        ) : (
          <>
            <a
              href={event.eventUrl}
              target="_blank"
              rel="noopener noreferrer"
              class={`inline-flex items-center gap-2 font-semibold py-2.5 px-4 rounded-lg text-sm transition-all duration-200 shadow-sm hover:shadow !text-white ${colors.buttonPrimary}`}
            >
              RSVP on Meetup
            </a>
            <a
              href={getGoogleCalendarLink(event)}
              target="_blank"
              rel="noopener noreferrer"
              class={`inline-flex items-center gap-1.5 font-medium py-2.5 px-4 rounded-lg text-sm transition-all duration-200 ${colors.buttonSecondary}`}
            >
              <span>üìÖ</span>
              <span>Add to Calendar</span>
            </a>
          </>
        )
      }
    </footer>
  </div>
</div>
