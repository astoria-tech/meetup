name: Issue to PR

on:
  issues:
    types: [opened, reopened]

jobs:
  createPR:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Check Issue Title
        run: |
          if [[ "${{ github.event.issue.title }}" != "[Presentation]*" ]]; then
            echo "Issue does not start with [Presentation]. Exiting..."
            exit 0
          fi

      - name: Issue Forms Body Parser
        id: parse
        uses: zentered/issue-forms-body-parser@v2.0.0

      - name: Issue Definitions
        id: define
        run: |
          jsonData='${{ steps.parse.outputs.data }}'
          echo "$jsonData"

          name=$(echo "$jsonData" | jq -r '.name.text')
          echo "name=$name" >> "$GITHUB_OUTPUT"
          echo "$name"

          gitHubUsername=$(echo "$jsonData" | jq -r '."git-hub-username".text')
          echo "gitHubUsername=$gitHubUsername" >> "$GITHUB_OUTPUT"
          echo "$gitHubUsername"

          linkedInProfileURL=$(echo "$jsonData" | jq -r '."linked-in-profile-url".text')
          echo "linkedInProfileURL=$linkedInProfileURL" >> "$GITHUB_OUTPUT"
          echo "$linkedInProfileURL"

          website=$(echo "$jsonData" | jq -r '.website.text')
          echo "website=$website" >> "$GITHUB_OUTPUT"
          echo "$website"

          profileImage=$(echo "$jsonData" | jq -r '."profile-image".text')
          echo "profileImage=$profileImage" >> "$GITHUB_OUTPUT"
          echo "$profileImage"

      - name: Create Slug
        id: slug
        run: |
          echo "slug=$(echo '${{ steps.define.outputs.name }}' | tr '[:upper:]' '[:lower:]' | sed -e 's/[^a-zA-Z0-9]/-/g' -e 's/--*/-/g')" >> $GITHUB_OUTPUT

      - name: Create new speaker file
        run: |
          echo "---" > ./src/content/speakers/${{ steps.slug.outputs.slug }}.md

          add_url() {
            property_name=$1
            property_value=$2
            # Enhanced URL pattern for validation
            url_pattern="^(https?://)?([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(/[-a-zA-Z0-9:%_+.~#?&//=]*)?$"
            
            if [[ -n "$property_value" ]]; then
              # Remove any < or > characters
              property_value=$(echo "$property_value" | sed 's/[<>]//g')
              
              # Check if the property_value matches the URL pattern
              if [[ $property_value =~ $url_pattern ]]; then
                echo "$property_name: $property_value" >> ./src/content/presentations/${{ steps.slug.outputs.slug }}.md
              else
                echo "Invalid URL: $property_value"
              fi
            fi
          }

          # Check if githubUsername is not empty
          if [ -n "${{ steps.define.outputs.githubUsername }}" ]; then
            githubUsername=$(echo '${{ steps.define.outputs.githubUsername }}' | sed 's/@//g')
            echo "githubUsername: $githubUsername" >> ./src/content/presentations/${{ steps.slug.outputs.slug }}.md
          fi

          # Corrected function calls
          add_url "linkedInProfileURL" "${{ steps.define.outputs.linkedInProfileURL }}"
          add_url "profileImage" "${{ steps.define.outputs.profileImage }}"

          # Check if name is not empty
          if [ -n "${{ steps.define.outputs.name }}" ]; then
            echo "name: ${{ steps.define.outputs.name }}" >> ./src/content/presentations/${{ steps.slug.outputs.slug }}.md
          fi

          add_url "website" "${{ steps.define.outputs.website }}"

          echo "---" >> ./src/content/presentations/${{ steps.slug.outputs.slug }}.md
          echo "" >> ./src/content/presentations/${{ steps.slug.outputs.slug }}.md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          commit-message: 'New Presentation Submission: ${{  steps.define.outputs.name }} (#${{ github.event.issue.number }})'
          title: 'New Presentation Submission: ${{  steps.define.outputs.name }}'
          body: |
            Adds a new presentation based on issue #${{ github.event.issue.number }}.
          branch: 'new-presentation-${{ steps.slug.outputs.slug }}-${{ github.run_id }}'
